const User = require("../models/userModel");
const bcrypt = require("bcryptjs");
const { generateToken } = require("../middlewares/authentication");

exports.createUser = async (req, res) => {
    try {
        const { name, email, password } = req.body;
        if (!name || !email || !password) {
            return res.status(400).json({
                success: false,
                message: "All fields are required",
            });
        }

        // Check if user already exists
        const existingUser = await User.findOne({ email });
        if (existingUser) {
            return res.status(400).json({
                success: false,
                message: "Email is already in use",
            });
        }

        // Hash password
        const hashedPassword = await bcrypt.hash(password, 10);

        // Create user
        const user = await User.create({ name, email, password: hashedPassword });
        res.status(201).json({
            success: true,
            message: "User registered successfully. log in to view your profile",
            data:user, 
        });
    } catch (e) {
        res.status(500).json({
            success: false,
            message: e.message,
        });
    }
};
exports.signIn = async (req, res) => {
    try {
        const { email, password } = req.body;
        if (!email || !password) {
            return res.status(400).json({
                success: false,
                message: "Please provide email and password",
            });
        }

        const user = await User.findOne({ email }).select("+password");
        if (!user) {
            return res.status(404).json({
                success: false,
                message: "User not found",
            });
        }
        const isPasswordMatch = await bcrypt.compare(password, user.password);

        if (!isPasswordMatch) {
            return res.status(401).json({
                success: false,
                message: "Invalid email or password",
            });
        }

        const token = generateToken(user);
        res.status(200).json({
            success: true,
            token,
            user,
            message: "You have logged in successfully",
        });
    } catch (e) {
        res.status(500).json({
            success: false,
            message: e.message,
        });    }
};

exports.signOut = (req, res) => {
    try {
        res.status(200).json({
            success: true,
            token: null,
            message: "Logged out successfully",
        });
    } catch (e) {
        res.status(500).json({
            success: false,
            message: e.message,
        });
    }
};

exports.getUserById = async (req, res) => {
    try {
        // Find user and populate referenced fields
        const user = await User.findById(req.params.id)
            .populate("posts")           // Populate posts created by user
            .populate("comments")        // Populate user's comments
            .populate("favourites")      // Populate user's favorite posts
            .populate("liked")           // Populate posts liked by user
            .populate("disliked")      // Populate posts disliked by user
            .populate("reading_list")      
            .populate("subscribers")     
            .populate("subscribed");      

        // If user does not exist
        if (!user) {
            return res.status(404).json({
                success: false,
                message: "User not found",
            });
        }

        // Send response with populated user data
        res.status(200).json({
            success: true,
            data: user,
        });
    } catch (error) {
        res.status(500).json({
            success: false,
            message: error.message,
        });
    }
};

exports.getAllUsers = async (req,res)=>{
    try{
        const users = await User.find();
        res.status(200).json({
            success:true,
            data:users,
        });
    }
    catch(e){
        res.status(500).json({
            success:false,
            message:error.message,
        });
    }
};
exports.updateUser = async (req,res)=>{
    try{
        const user = await User.findByIdAndUpdate(req.params.id,req.body,{
            new:true,
            runValidators:true,
        });
        if(!user){
            res.status(404).json({
                success:false,
                message:"user not found",
            });
        }
        res.status(200).json({
            success:true,
            data:user,
        });
    }
    catch(e){
        res.status(500).json({
            success:false,
            message:error.message,
        });
    }
};
exports.resetPassword = async (req, res) => {
    try {
        const { email,newPassword } = req.body;
        if (!email || !newPassword) {
            return res.status(400).json({
                success: false,
                message: "Please provide email and new password",
            });
        }
        const user = await User.findOne({ email });
        if (!user) {
            return res.status(404).json({
                success: false,
                message: "No User has Signed Up with this email. Sign Up Now!",
            });
        }
        const hashedPassword = await bcrypt.hash(newPassword, 10);
        user.password = hashedPassword;
        await user.save();
        res.status(200).json({
            success: true,
            message: "Password reset successfully",
        });
    } catch (e) {
        res.status(500).json({
            success: false,
            message: e.message,
        });
    }
};




// exports.subscribeToUser = async (req, res) => {
//     try {
//         const userId = req.user.id;  // Currently logged-in user
//         const targetUserId = req.params.id;  // User to subscribe to

//         if (userId === targetUserId) {
//             return res.status(400).json({
//                 success: false,
//                 message: "You cannot subscribe to yourself",
//             });
//         }

//         const user = await User.findById(userId);
//         const targetUser = await User.findById(targetUserId);

//         if (!targetUser) {
//             return res.status(404).json({
//                 success: false,
//                 message: "User to subscribe to not found",
//             });
//         }

//         // Add subscription if not already subscribed
//         if (!user.subscribed.includes(targetUserId)) {
//             user.subscribed.push(targetUserId);
//             targetUser.subscribers.push(userId);
//             await user.save();
//             await targetUser.save();
//         }

//         res.status(200).json({
//             success: true,
//             message: "Subscribed successfully",
//         });
//     } catch (error) {
//         res.status(500).json({ success: false, message: error.message });
//     }
// };

// exports.unsubscribeFromUser = async (req, res) => {
//     try {
//         const userId = req.user.id;
//         const targetUserId = req.params.id;

//         const user = await User.findById(userId);
//         const targetUser = await User.findById(targetUserId);

//         if (!targetUser) {
//             return res.status(404).json({
//                 success: false,
//                 message: "User to unsubscribe from not found",
//             });
//         }

//         // Remove subscription if exists
//         user.subscribed = user.subscribed.filter(id => id.toString() !== targetUserId);
//         targetUser.subscribers = targetUser.subscribers.filter(id => id.toString() !== userId);

//         await user.save();
//         await targetUser.save();

//         res.status(200).json({
//             success: true,
//             message: "Unsubscribed successfully",
//         });
//     } catch (error) {
//         res.status(500).json({ success: false, message: error.message });
//     }
// };
exports.addToReadingList = async (req, res) => {
    try {
        const userId = req.user.id;
        const postId = req.params.postId;

        const user = await User.findById(userId);
        if (!user) {
            return res.status(404).json({ success: false, message: "User not found" });
        }

        // Add post to reading list if not already added
        if (!user.reading_list.includes(postId)) {
            user.reading_list.push(postId);
            await user.save();
        }

        res.status(200).json({
            success: true,
            message: "Post added to reading list",
        });
    } catch (error) {
        res.status(500).json({ success: false, message: error.message });
    }
};

exports.removeFromReadingList = async (req, res) => {
    try {
        const userId = req.user.id;
        const postId = req.params.postId;

        const user = await User.findById(userId);
        if (!user) {
            return res.status(404).json({ success: false, message: "User not found" });
        }

        // Remove post from reading list
        user.reading_list = user.reading_list.filter(id => id.toString() !== postId);
        await user.save();

        res.status(200).json({
            success: true,
            message: "Post removed from reading list",
        });
    } catch (error) {
        res.status(500).json({ success: false, message: error.message });
    }
};







exports.getVisitorProfile = async (req, res) => {
    try {
        
      const user = await User.findById(req.params.id).select("name profilePicture subscribers posts").populate("posts");

      if (!user) return res.status(404).json({ error: "User not found" });
  
      res.status(200).json({
        success: true,
        data:user,
    });
    } catch (error) {
      res.status(500).json({ error: "Server error" });
    }
  };
  






exports.toggleSubscription = async (req, res) => {
    try {
      const user = await User.findById(req.params.userId);
      if (!user) return res.status(404).json({ error: "User not found" });
  
      const currentUserId = req.user.id;
      if (user.subscribers.includes(currentUserId)) {
        user.subscribers.pull(currentUserId);
      } else {
        user.subscribers.push(currentUserId);
      }
      await user.save();
  
      res.json({ 
        message: "Subscription updated", 
        subscribers: user.subscribers 
    });
    } catch (error) {
      res.status(500).json({ error: "Server error" });
    }
  };
  